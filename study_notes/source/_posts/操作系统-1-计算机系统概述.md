---
layout: post
title: 操作系统-1-计算机系统概述
date: 2024-12-04 19:52:19
tags:
categories: 操作系统
hidden: true
---

# 什么是操作系统
## 功能与概念

操作系统（OS）是**控制和管理整个计算机接口的硬件和软件资源**，合理地组织调度计算机的**工作**和**资源分配**，提供给用户和其他软件方便的**接口和环境**，是计算机系统中最基本的**系统软件**，即：

1. 操作系统是系统资源的管理者
<img src="https://b.bdstatic.com/comment/HPpFm-ziUYsgpwpjCcQ1VA6d6218c725d2b41a528d32229b96cf1c.png" width=400 />

2. 向上层（用户、应用程序）提供方便易用的服务
硬件只能接收和处理二进制，这对一般的应用程序来说并不友好。操作系统的存在将这些硬件功能封装成了更用户友好的接口（例如GUI或cmd），用户只需要调用这些接口就可以实现与底层硬件的交互。可以说OS是一个大型中间件。
> **联机命令接口、脱机命令接口与程序接口**
联机命令接口就是我们常在cmd中使用的交互式命令，特点为用户发送一句命令，系统处理后用户再发送一条。命令行追求的是**交互性**。
脱机命令接口就是批处理（.bat文件），开发者将一系列命令写进文件，系统直接执行这一系列文件。批处理追求的是**效率**、**资源利用率**和**吞吐量**。
程序接口就是系统调用（System Call）/广义指令，**只能在程序代码中间接使用**（普通用户无法接触）。

3. 操作系统是最接近硬件的**软件**
操作系统可以实现对硬件机器的拓展，通过将CPU、内存、磁盘、显示器、键鼠等硬件合理地组织起来，让各种硬件互相协调配合，实现更多复杂功能（例如文件系统等）。

<img src="https://b.bdstatic.com/comment/HPpFm-ziUYsgpwpjCcQ1VA7ed21391f51586bfeaacb4ba2d55b587.png" alt="操作系统的位置" width=250/>

## 操作系统的四个特征

<img src="https://b.bdstatic.com/comment/HPpFm-ziUYsgpwpjCcQ1VA610a04be64a92c024ba26f0ae37e0ec4.png" width=300 />

操作系统的四个特征是并发、共享、虚拟和异步，其中**并发和共享是两个最基本的特征**。

### 并发
- **并发**：指两个或多个程序在统一时间间隔内发生。这些程序宏观上是同时运行的，但微观上是交替运行的。操作系统是伴随“**多道程序技术**”出现的，因此操作系统和并发是一起诞生的，并发是操作系统的基本特征之一。
- **并行**：指两个或多个程序在同一时刻同时执行。对于多核CPU来说并行是可能的，但单核CPU只能并发执行。

{% note info **多道程序技术的基本特征** %}
如果没有多道程序并发，一般的顺序程序具有以下四个特征：
1. 顺序性
2. 封闭性（上面两个特性是所有顺序程序具有的特征）
3. 程序执行结果的确定性（幂等性）
4. 程序执行结果的可再现性（鲁棒性）

在引入多道程序并发之后，多个程序互相争抢、交替使用CPU资源（这体现了**制约性**），顺序性和封闭性便失去了。由于分配的不确定，3和4也不存在。
因此，多道程序并发的基本特征是**制约性**。
{% endnote %}

<img src="https://www.itbaizhan.com/wiki/imgs/image-20211204095202680.png" width=450 />

### 共享
共享即**资源共享**，指系统中的资源可供内存中多个并发执行的进程共同使用。
- **互斥共享**：一个时间段内只允许一个进程访问该资源（加了锁），例如QQ和微信只有一个进程能使用摄像头。
- **同时共享**：一个时间段内允许多个进程同时访问该资源，例如游戏和音乐播放器两个进程都能播放音乐。

并发和共享是相辅相成的，失去其中之一另一方就没有了意义，因此二者为OS最基本的两个特征。

### 虚拟
虚拟指的是**虚拟内存**，与物理内存概念相对。一个电脑的内存可能不大，却能同时运行远超内存的应用，这是利用了虚拟的**空分复用技术**。
并发是“**时分复用技术**”的体现，虚拟依托并发实现。

### 异步
异步指的是在多道程序环境下允许多个程序并发执行，但由于资源有限，进程的执行不是一贯到底而是走走停停的（以不可知的速度向前推进），这就是异步性。
从上文可以看出，异步依托并发实现。

# 操作系统的运行机制
<img src="https://b.bdstatic.com/comment/HPpFm-ziUYsgpwpjCcQ1VA35caacb78813ed90f1dedb011e6f6ab6.png" width=400/>

- **程序**：
    - **内核程序**：内核程序组成了操作系统内核（Kernel），是OS最核心、最必不可少的部分，也是最接近硬件的部分。
    - **应用程序**：一般来说，作为开发者我们写的都是应用程序，是运行在操作系统之上的。

- **指令**：CPU能识别和处理的最基本的命令（二进制机器码）。高级语言（例如C）经过编译器处理后会被翻译成机器指令。
    - **特权指令**：一些影响重大的指令，只允许管理者（操作系统的内核程序）使用。
        - 开关中断
        - 写时钟
        - I/O
        - 写程序状态字寄存器（PSW）
        - 清除整个内存
    - **非特权指令**：大家都能用的指令，例如加法指令、减法指令。
        - 存取数
        - 读时钟
        - 加减乘除
        - 寄存器清零
        - 压栈弹栈
        - 跳转
        - 系统调用（trap）

- **CPU状态**：处理器所处的状态，与**程序状态字寄存器**（PSW）有关，为1时处于内核态、为0时处于用户态。从内核态转变为用户态是通过内核程序的**特权指令**实现的；用户态转变为内核态发现在应用程序**中断**的时候（处理中断的程序是内核程序）。
    - **内核态/管态**：正在运行内核程序，可以执行特权指令。
    - **用户态/目态**：正在运行应用程序，只能执行非特权指令。

## 中断和异常
一般来说中断指**外中断**（狭义的中断），异常指**内中断**（广义的中断）。其中的关系如下：

<img src="https://b.bdstatic.com/comment/HPpFm-ziUYsgpwpjCcQ1VAc6399b805a9a0e366214f36415d2c3fc.png" />

> 注意：中断向量指的是中断处理程序的入口地址。中断向量地址指的是中断向量的地址。

## 系统调用
前文中提到过，系统调用是一类能在**应用程序**中使用的指令。现代高级语言一般将系统调用封装到了一系列接口中（例如C的库函数），在调用库函数 `malloc` 时就根据分配内存的大小（128k）在底层使用了系统调用 `brk` 或 `mmap`。由此可见，**系统调用比库函数更底层**。并不是所有库函数都调用了系统调用。
一些资源是互斥共享资源（例如存储分配、I/O操作、文件管理等），多个用户进程想使用该类资源时必须通过系统调用向内核发出请求，由内核对各个请求进行协调处理，避免并发运行时产生错误，确保系统的**稳定性**和**安全性**。

<img src="https://b.bdstatic.com/comment/HPpFm-ziUYsgpwpjCcQ1VA70525c71b44f9e7e50503467105a8b38.png" width=450 />

{% note info **系统调用的过程** %}
在应用程序中，如果想要执行系统调用，会经过以下几个步骤：
1. 向CPU发送一条或多条**传参指令**，参数可能指明了系统调用的类型，或是其他内容
2. 向CPU发送**陷入指令**（即trap/访管指令，是非特权指令），触发内中断而中断应用程序，从用户态转变为内核态
3. 执行系统**调用入口程序**（内核程序），即处理陷入指令的中断指令，处理寄存器中的参数，决定使用哪个系统调用程序
4. 调用入口程序调用**对应的系统调用程序**，根据参数处理相关逻辑
5. 通过特权指令回到用户态，恢复执行用户程序中剩下的其他指令
{% endnote %}

# 操作系统体系结构



# 操作系统引导



# 虚拟机