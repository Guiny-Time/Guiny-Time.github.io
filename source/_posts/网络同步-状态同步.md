---
title: 网络同步-状态同步
tags: ['游戏编程','网络','网络同步','状态同步','经验分享']
categories: 探索发现
date: 2024-07-24
updated: 2024-07-25
cover: https://b.bdstatic.com/comment/HPpFm-ziUYsgpwpjCcQ1VA6c73afe111ad1f25714927140448b662.png
---

# 什么是状态同步？
状态同步就类似于我们在网络同步系列的第一篇文章中说的直接同步用户的**状态**。客户端将指令发送给服务端，服务端计算出状态后广播给其他客户端，客户端收到后进行更新。这样虽然会加重服务端的运算负载，但可以有效避免客户端作弊的发生。

当然，我们还可以结合一下**分布式**运算的想法，将计算压力分摊到客户端上。在这种模式中，客户端将部分指令即时计算成状态之后，将状态发送给其他客户端（其他客户端同理），其他客户端收到后进行更新。

<img src="https://b.bdstatic.com/comment/HPpFm-ziUYsgpwpjCcQ1VAdc904947446c8ac38954adf15226d176.png" width=500 />

## 状态同步的临界问题
仔细观察下图所示的临界情况：

<center>
<img src="Clipboard_2024-09-20-16-21-17.png" width="400">
</center>

在这个情况中，假设：

1. 下方的玩家向上走了一步，向服务端发送“向上一步、夺旗”的状态；
2. 上方的玩家在接收到这个状态之前向下走了一步，向服务端发送“向下一步、夺旗”的状态。
3. 此时两个玩家的状态都变成了“夺旗”，到底谁获得了胜利呢？

这就涉及到状态同步的**仲裁权问题**。两个玩家都在竞争“仲裁权”，我们需要结合具体的信息（例如状态更新的时间）进行公平公正的仲裁。有两种可行的思路：
### 强一致性
服务器模式（由服务器计算指令）就是一种**强一致性**的方式，因为只存在一个逻辑仲裁点（服务器），这从根本上避免了冲突。两个用户把指令发送到服务器上，服务器根据指令发送的时间戳判断哪个玩家先夺得旗帜。

而在分布式模式中，不同客户端仅对单一状态进行仲裁，两个客户端不能仲裁同一个状态，这样就可以实现仲裁权的分割。只不过这个做法比较理想化，不符合联机游戏的特征、存在扩展风险。

### 弱一致性
在弱一致性方法中，我们首先要对所有一致性做一个区分：哪些是**核心一致性**，哪些是**非核心一致性**？

- **核心一致性**：可能影响双方的状态采用单点仲裁处理、异步交互（如：fps游戏中是否命中、赛车游戏中的道具），这部分需要放在服务端上进行计算。
    - 单点逻辑仲裁**对操作响应的延迟很敏感**。
    - 比较慢，因为需要服务器计算后合包再发送给各个客户端，这中间存在时延。因此更适合**对核心仲裁延迟相对不敏感**的情况（比如fps的命中判定并不是立刻判定完成的，但结合“子弹存在飞行时间”等ux因素，对玩家的体验影响并不太大）。
    - 一致性有容错空间。

- **非核心一致性**：仅对自身有影响的状态采用仲裁分割、延迟同步（如：赛车游戏中自身位置、fps游戏中的位置等），这部分可以分布式处理。
    - 对于**物理**、**3D**这些比较复杂的运算，如果全部交给服务端将对其造成较大的计算负荷，因此这部分状态判定可以交由客户端本身进行处理。

## fps的回溯判定
fps对于精度的判断要求很高，在存在服务器状态延迟、射击指令延迟的时候应该怎么准确的进行命中仲裁呢？此时服务器需要**回溯**射击发生当时的状态，进行判断。

<center>
<img src="Clipboard_2024-09-20-17-03-56.png" width="300">
</center>

在上图所示的例子中，蓝色玩家在射击时向服务器发送了射击指令，经过延迟服务器收到后计算出橙色玩家已经走到了下面的位置、子弹飞到了右侧的位置，此时子弹和橙色玩家并没有接触。

但这样我们就可以直接判断子弹没有命中橙色玩家吗？显然是不行的，因为我们不知道子弹飞行的过程中是否击中了橙色玩家，因此需要做“**回溯判定**”的操作。服务器会采用一些高效的逐帧检查，直到检测出命中/不命中。

<center>
<img src="Clipboard_2024-09-20-17-35-35.png" width="300">
</center>

# 优点与缺点
## **优点**
    - 支持更多玩家和更长时间的运行
    - 更安全（不容易作弊）
    - 断线重连更快
    - 实时性更好
    - 适合小规模状态/可划分子系统（适用于fps/赛车/三消等）
    - 较小的计算量
    - 输入延迟低，因为本地就计算好状态了

## **缺点**
  - 大规模状态时同步的数据也大
  - 流量大
  - 分布式计算/复杂逻辑的一致性难以协调，导致后期维护成本高
  - 不好实现回放
  - 实现复杂

# 参考资料
https://gameinstitute.qq.com/course/detail/10242
https://www.youxituoluo.com/528021.html