---
title: C#进阶（三）-委托与事件
date: 2024-12-10 23:12:51
tags:
cover: https://b.bdstatic.com/comment/HPpFm-ziUYsgpwpjCcQ1VAd7b8b231ed9781bba1c0554bcf9d08a4.png
hidden: true
---

委托（delegate）类似于C++中的函数指针，是类型化了的函数指针（一种可以存放特定参数/返回值类型方法的容器）；多播委托（multicast delegate）则代表一个委托存放了多个函数。通过委托可以实现事件和回调的功能。

题外话：多播委托
多播委托的底层是一个链表，我们称之为“委托链”，因此多播委托也可以被称为链式委托。当两个及以上的委托被链接到一个委托链时，调用头部的委托将导致该链上的所有委托方法都被执行。通过 System.MulticastDelegate 中的 GetInvocationList() 方法，可以以数组的形式获得整个链式委托中的所有委托。
如果在某个委托方法中修改了委托链（例如+=了新的方法），新委托链是不会被执行的，因为本次执行的委托引用指向的是旧的链。委托是一种引用类型（类似于字符串一般具有不变的特性），在增加或移除方法时实际上创建了一个新的委托实例并把它赋给当前的委托变量。在多播委托执行时，C# 会先将当前委托链拷贝出来，然后按这个拷贝的顺序依次调用。这保证了即使在回调中修改了委托链，拷贝的链条也不会被改变。
需要注意的是，对于有返回值的多播委托，如果没有手动调用委托链上的每个方法，只能得到委托链上最后被调用的方法的返回值。

C# 将观察者模式集成到了 event上 。event 是对于委托（delegate）的一种更安全的封装方式（只能作为成员存在于类/接口或结构体中），程序员无法在类外部赋值或调用事件，这使得委托的使用更加安全。C# event 是一种成员，用于将特定的事件通知发送给订阅者。事件通常用于实现观察者模式，它允许一个对象将状态的变化通知其他对象，而不需要知道这些对象的细节。

事件基本上说是一个用户操作，如按键、点击、鼠标移动等等，或者是一些提示信息，如系统生成的通知。应用程序需要在事件发生时响应事件。

